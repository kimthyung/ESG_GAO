<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>S&P 500 적립식 수익률 시뮬레이터</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">S&P 500 적립식 수익률 시뮬레이터</h1>
    <p class="text-sm text-slate-500 mb-4">2025-10-06과 2025-10-24에 각각 180,000원을 투자하고 이후 매월 24일에 동일 금액을 투자한다고 가정합니다.</p>

    <div id="summary" class="grid grid-cols-2 gap-3 mb-6">
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">총 납입액</div>
        <div id="invested" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">평가금액</div>
        <div id="value" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">평가손익</div>
        <div id="pnl" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">수익률</div>
        <div id="roi" class="text-lg font-semibold">-</div>
      </div>
    </div>

    <canvas id="chart" height="120"></canvas>

    <p class="text-xs text-slate-400 mt-6">데이터 소스: <a href="https://stooq.com/" class="underline" target="_blank">Stooq</a> (^spx). 수수료/세금/환율 미반영.</p>
  </div>

  <script>
    const fmtKRW = v => new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v);

    async function fetchSPX(){
      const urls = [
        'https://stooq.com/q/d/l/?s=%5Espx&i=d',
        'https://r.jina.ai/http://stooq.com/q/d/l/?s=%5Espx&i=d'
      ];
      for(const u of urls){
        try{
          const res = await fetch(u,{cache:'no-cache',mode:'cors'});
          if(!res.ok) continue;
          const text = await res.text();
          const lines = text.trim().split(/\n/);
          lines.shift();
          return lines.map(l=>{const [d,o,h,lo,c]=l.split(',');return {date:d,close:parseFloat(c)};});
        }catch(e){console.warn(e)}
      }
      throw new Error('가격 데이터를 불러오지 못했습니다.');
    }

    function toDate(s){return new Date(s+'T00:00:00Z');}
    function addMonths(d,m){const x=new Date(d);x.setUTCMonth(x.getUTCMonth()+m);return x;}
    function ymd(d){return d.toISOString().slice(0,10);}

    function findTrade(rows,date){return rows.find(r=>r.date>=date)||null;}

    function simulate(rows){
      const plans=[
        {date:'2025-10-06',amount:180000},
        {date:'2025-10-24',amount:180000}
      ];
      // future monthly contributions
      let cur=new Date(Date.UTC(2025,10,1));
      const last=rows[rows.length-1].date;
      while(ymd(cur).slice(0,7)<=last.slice(0,7)){
        const d=`${cur.getUTCFullYear()}-${String(cur.getUTCMonth()+1).padStart(2,'0')}-24`;
        const trade=findTrade(rows,d);
        if(trade) plans.push({date:trade.date,amount:180000});
        cur=addMonths(cur,1);
      }

      const fills=[];let units=0,invested=0;
      for(const p of plans){
        const t=findTrade(rows,p.date);if(!t)continue;
        const u=p.amount/t.close;invested+=p.amount;units+=u;fills.push({date:t.date,price:t.close,units:u});
      }
      const curPrice=rows[rows.length-1].close;
      const val=units*curPrice;
      const pnl=val-invested;
      const roi=pnl/invested;
      return {invested,val,pnl,roi,fills};
    }

    async function run(){
      const data=await fetchSPX();
      const r=simulate(data);
      document.getElementById('invested').textContent=fmtKRW(r.invested);
      document.getElementById('value').textContent=fmtKRW(r.val);
      document.getElementById('pnl').textContent=fmtKRW(r.pnl);
      document.getElementById('roi').textContent=(r.roi*100).toFixed(2)+'%';
      const ctx=document.getElementById('chart');
      new Chart(ctx,{type:'line',data:{labels:r.fills.map(f=>f.date),datasets:[{data:r.fills.map(f=>f.price),label:'S&P 500',borderWidth:2,tension:0.2}]},options:{plugins:{legend:{display:false}}}});
    }

    run();
  </script>
</body>
</html>
