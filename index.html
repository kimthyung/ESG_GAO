<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>미국을 따르지 않은 죗값</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>body{font-feature-settings:"ss01" on,"case" on}</style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-2">S&P 500 적립식 수익률 시뮬레이터</h1>
    <p class="text-sm text-slate-600 mb-6">고정 가정: 2025-10-06·2025-10-24 각 180,000원 투자, 이후 매월 24일 동일 금액 투자. <span class="font-semibold">입금 시점은 한국시간(KST) 밤 23:59</span>이며, 이를 <span class="font-semibold">미국 동부시간(ET) 날짜로 변환</span>해 해당 날짜 <em>이후 첫 거래일</em>에 체결합니다. 환율·세금 반영, 배당은 원천징수 후 전액 재투자.</p>

    <div id="summary" class="grid grid-cols-2 gap-3 mb-6">
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">총 납입액</div>
        <div id="invested" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">평가금액(세후·배당재투자)</div>
        <div id="value" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">평가손익(세후)</div>
        <div id="pnl" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">수익률(세후)</div>
        <div id="roi" class="text-lg font-semibold">-</div>
      </div>
    </div>

    <canvas id="chart" height="120"></canvas>

    <p id="notice" class="text-xs text-amber-600 mt-4 hidden"></p>
    <p class="text-xs text-slate-400 mt-2">가격: Stooq ^spx, 환율: exchangerate.host → frankfurter.app 폴백. 배당수익률은 일정(연 1.3%)으로 근사. 배당 15% 원천징수 후 재투자. 양도세는 최종 일괄 계산(공제 250만원·세율 22%).</p>
  </div>

  <script>
    // === 세금/배당/환율/시간대 가정 ===
    var TAX_RATE_CG = 0.22;       // 양도소득세(지방세 포함) 가정 22%
    var TAX_DED_KRW = 2500000;    // 연 250만원 기본공제
    var DIVIDEND_YIELD_ANNUAL = 0.013; // 연 배당수익률(상수 근사)
    var DIV_WITHHOLDING = 0.15;   // 미국 배당 원천징수 15%
    var TRADING_DAYS = 252;       // 일일화 기준치
    var DEPOSIT_LOCAL_TIME = '23:59'; // KST 기준 입금 시간

    function fmtKRW(v){ return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v); }
    function ymd(d){ return d.toISOString().slice(0,10); }
    function addMonths(d,m){ var x=new Date(d); x.setUTCMonth(x.getUTCMonth()+m); return x; }

    // KST yyyy-mm-dd + 23:59 를 ET 날짜(yyyy-mm-dd)로 변환
    function kstDepositToEtYmd(kstYmd, hhmm){
      var parts = (hhmm||'23:59').split(':');
      var iso = kstYmd + 'T' + parts[0].padStart(2,'0') + ':' + parts[1].padStart(2,'0') + ':00+09:00';
      var kst = new Date(iso);
      // format to ET yyyy-mm-dd reliably using en-CA
      var etYmd = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/New_York', year:'numeric', month:'2-digit', day:'2-digit' }).format(kst);
      return etYmd; // e.g., 2025-10-23
    }

    async function fetchSPX(){
      var urls=[
        'https://stooq.com/q/d/l/?s=%5Espx&i=d',
        'https://r.jina.ai/http://stooq.com/q/d/l/?s=%5Espx&i=d',
        'https://r.jina.ai/http://stooq.pl/q/d/l/?s=%5Espx&i=d'
      ];
      function parseCsv(text){
        var lines = text.trim().split(/\r?\n/).filter(function(l){return /\d{4}-\d{2}-\d{2},/.test(l) || /^date,open,high,low,close/i.test(l)});
        if(/^date,open,high,low,close/i.test(lines[0])) lines.shift();
        var rows = lines.map(function(l){ var parts=l.split(','); return {date:parts[0], close:Number(parts[4])}; })
                        .filter(function(r){return Number.isFinite(r.close)});
        if(rows.length===0) throw new Error('SPX CSV parse error');
        return rows;
      }
      for(var i=0;i<urls.length;i++){
        try{ var res=await fetch(urls[i],{cache:'no-cache'}); if(!res.ok) throw 0; return parseCsv(await res.text()); }catch(e){}
      }
      throw new Error('S&P 500 가격을 가져오지 못했습니다.');
    }

    async function fetchUSDKRW(fromYMD, toYMD){
      var eps=[
        'https://api.exchangerate.host/timeseries?base=USD&symbols=KRW&start_date='+fromYMD+'&end_date='+toYMD,
        'https://api.frankfurter.app/'+fromYMD+'..'+toYMD+'?from=USD&to=KRW'
      ];
      for(var i=0;i<eps.length;i++){
        try{
          var r = await fetch(eps[i],{cache:'no-cache'}); if(!r.ok) throw 0; var j = await r.json();
          var rates = {}; var k;
          if(j.rates){
            for(k in j.rates){ if(j.rates.hasOwnProperty(k)){ var obj=j.rates[k]; var v = obj.KRW || obj['KRW']; if(v) rates[k]=Number(v); }}
          }
          var keys = Object.keys(rates).sort(); if(keys.length===0) throw 0;
          var arr = keys.map(function(k){return {date:k, rate:rates[k]};}).sort(function(a,b){return a.date<b.date?-1:1});
          return {
            getRateOnOrBefore: function(d){
              var lo=0, hi=arr.length-1, ans=null; var mid;
              while(lo<=hi){ mid=(lo+hi>>1); if(arr[mid].date<=d){ ans=arr[mid]; lo=mid+1; } else { hi=mid-1; } }
              return ans? ans.rate : null;
            },
            firstDate: arr[0].date,
            lastDate: arr[arr.length-1].date
          };
        }catch(e){}
      }
      throw new Error('USD/KRW 환율을 가져오지 못했습니다.');
    }

    async function run(){
      try{
        var spx = await fetchSPX();

        // 1) 고정 플랜 입력을 KST 기준으로 설정
        var kstPlans=[ {kstDate:'2025-10-06', amountKRW:180000}, {kstDate:'2025-10-23', amountKRW:180000} ];
        // 2) 매월 24일 KST 23:59 입금 → ET 날짜로 변환 후 첫 거래일 체결
        var curKst = new Date(Date.UTC(2025,10,24,14,59,0)); // 2025-11-24 23:59 KST = UTC 14:59
        var lastYMD = spx[spx.length-1].date;
        function kstYmd(d){ return new Intl.DateTimeFormat('en-CA',{ timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' }).format(d); }
        while(kstYmd(curKst).slice(0,7) <= lastYMD.slice(0,7)){
          kstPlans.push({ kstDate: kstYmd(curKst), amountKRW: 180000 });
          curKst = addMonths(curKst, 1);
        }

        // 3) KST 입금일을 ET 기준 체결 기준일로 변환
        var plans=[];
        for(var a=0;a<kstPlans.length;a++){
          var kp = kstPlans[a];
          var etBase = kstDepositToEtYmd(kp.kstDate, DEPOSIT_LOCAL_TIME); // 예: 2025-10-24 KST 23:59 ⇒ 2025-10-24 또는 23 (ET, DST에 따라)
          // 해당 ET 날짜 이후 첫 거래일
          var trade = spx.find(function(r){ return r.date >= etBase; });
          if(trade){ plans.push({ date: trade.date, amountKRW: kp.amountKRW }); }
        }

        // 환율 범위
        var fromYMD = plans[0].date;
        var fx = await fetchUSDKRW(fromYMD, lastYMD);

        // === 체결 + 배당 재투자 ===
        var fills=[], totalUnits=0, investedKRW=0;
        for(var i=0;i<plans.length;i++){
          var p = plans[i]; var trade = spx.find(function(r){return r.date>=p.date}); if(!trade) continue;
          var rate = fx.getRateOnOrBefore(trade.date); if(!Number.isFinite(rate)) continue;
          var priceKRW = trade.close * rate; var units = p.amountKRW / priceKRW;
          totalUnits += units; investedKRW += p.amountKRW;
          fills.push({date:trade.date, priceUSD:trade.close, rateKRW:rate, priceKRW:priceKRW, amountKRW:p.amountKRW, units:units});
        }

        var divDaily = DIVIDEND_YIELD_ANNUAL / TRADING_DAYS;
        var curve=[], accUnits=0, j=0; var sortedFills=fills.slice().sort(function(a,b){return a.date<b.date?-1:1});
        for(var k=0;k<spx.length;k++){
          var r = spx[k];
          while(j<sortedFills.length && sortedFills[j].date===r.date){ accUnits += sortedFills[j].units; j++; }
          if(accUnits>0){
            var rate2 = fx.getRateOnOrBefore(r.date);
            if(Number.isFinite(rate2)){
              var dayValueKRW = accUnits * r.close * rate2;
              var divKRW = dayValueKRW * divDaily * (1 -  DIV_WITHHOLDING);
              var addedUnits = divKRW / (r.close * rate2);
              if(Number.isFinite(addedUnits) && addedUnits>0) accUnits += addedUnits;
              curve.push({date:r.date, valueKRW: accUnits * r.close * rate2});
            }
          }
        }

        var lastRate = fx.getRateOnOrBefore(lastYMD);
        var currentValueKRW = accUnits * spx[spx.length-1].close * lastRate;
        var grossGain = currentValueKRW - investedKRW;
        var taxable = Math.max(0, grossGain - TAX_DED_KRW);
        var tax = taxable * TAX_RATE_CG;
        var netValueKRW = currentValueKRW - Math.max(0, tax);
        var pnlAfterTax = netValueKRW - investedKRW;
        var roiAfterTax = investedKRW>0 ? pnlAfterTax / investedKRW : 0;

        document.getElementById('invested').textContent = fmtKRW(investedKRW);
        document.getElementById('value').textContent = fmtKRW(netValueKRW);
        document.getElementById('pnl').textContent = (pnlAfterTax>=0?'+':'')+fmtKRW(Math.abs(pnlAfterTax));
        document.getElementById('roi').textContent = (roiAfterTax*100).toFixed(2)+'%';

        var ctx=document.getElementById('chart');
        new Chart(ctx,{ type:'line', data:{ labels:curve.map(function(p){return p.date}), datasets:[{ data:curve.map(function(p){return p.valueKRW}), label:'평가금액(배당 재투자·세전·원화)', borderWidth:2, tension:0.18, pointRadius:0 }] }, options:{ plugins:{ legend:{display:false} }, scales:{ y:{ ticks:{ callback:function(v){return new Intl.NumberFormat('ko-KR').format(v)} } } } } });

        var n=document.getElementById('notice'); n.classList.remove('hidden');
        n.textContent = '시간대 반영: KST '+DEPOSIT_LOCAL_TIME+' 입금 → ET 날짜로 변환하여 해당 날짜 이후 첫 거래일 체결. 예: 2025-10-24 KST 입금이 DST 기간이면 ET 2025-10-23로 인식될 수 있음.';

      }catch(err){
        console.error(err);
        var n2=document.getElementById('notice'); n2.classList.remove('hidden');
        n2.textContent = '데이터/계산 오류: ' + (err.message||String(err));
      }
    }

    run();
  </script>
</body>
</html>
