<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>S&P 500 적립식 수익률 시뮬레이터</title>
  <meta name="description" content="S&P 500에 대한 적립식(DCA) 투자 수익을 실시간 지수 데이터로 계산합니다. 수수료/세금/환율은 기본적으로 무시합니다." />
  <!-- Tailwind via CDN (Play) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* fallback fonts for safer rendering on GitHub Pages */
    body { font-feature-settings: "ss01" on, "case" on; }
    .card { @apply bg-white shadow-lg rounded-2xl p-6 border border-slate-100; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">S&P 500 적립식 수익률 시뮬레이터</h1>
      <p class="text-sm text-slate-500 mt-1">기본 가정: <span class="font-medium">수수료/세금/환율 효과를 무시</span>하고 지수(가격)만 추종. 지수 데이터는 Stooq 일별 종가를 사용합니다.</p>
    </header>

    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="card">
        <h2 class="font-semibold mb-3">투자 일정</h2>
        <form id="config-form" class="space-y-3">
          <div>
            <label class="text-sm text-slate-600">초기 납입</label>
            <div class="grid grid-cols-2 gap-2 mt-1">
              <input id="first-date" type="date" class="w-full rounded-lg border-slate-200" />
              <input id="first-amount" type="number" step="1000" class="w-full rounded-lg border-slate-200" placeholder="원" />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-600">두 번째 납입</label>
            <div class="grid grid-cols-2 gap-2 mt-1">
              <input id="second-date" type="date" class="w-full rounded-lg border-slate-200" />
              <input id="second-amount" type="number" step="1000" class="w-full rounded-lg border-slate-200" placeholder="원" />
            </div>
          </div>
          <div>
            <label class="text-sm text-slate-600">매월 정기 납입</label>
            <div class="grid grid-cols-3 gap-2 mt-1">
              <input id="recurring-day" type="number" min="1" max="28" class="w-full rounded-lg border-slate-200" placeholder="일(1-28)" />
              <input id="recurring-amount" type="number" step="1000" class="w-full rounded-lg border-slate-200" placeholder="원" />
              <input id="recurring-start" type="month" class="w-full rounded-lg border-slate-200" />
            </div>
            <p class="text-[12px] text-slate-400 mt-1">※ 해당 월의 <span class="underline">해당 일자 이상</span>의 첫 거래일에 체결 처리</p>
          </div>

          <div class="pt-2 flex gap-2">
            <button type="button" id="run-btn" class="rounded-xl px-4 py-2 bg-slate-900 text-white">계산하기</button>
            <button type="button" id="reset-btn" class="rounded-xl px-4 py-2 border">초기화</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2 class="font-semibold mb-3">결과 요약</h2>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="bg-slate-50 rounded-xl p-3">
            <div class="text-slate-500">총 납입액</div>
            <div id="invested" class="text-lg font-semibold mono">-</div>
          </div>
          <div class="bg-slate-50 rounded-xl p-3">
            <div class="text-slate-500">평가금액</div>
            <div id="value" class="text-lg font-semibold mono">-</div>
          </div>
          <div class="bg-slate-50 rounded-xl p-3">
            <div class="text-slate-500">평가손익</div>
            <div id="pnl" class="text-lg font-semibold mono">-</div>
          </div>
          <div class="bg-slate-50 rounded-xl p-3">
            <div class="text-slate-500">수익률</div>
            <div id="roi" class="text-lg font-semibold mono">-</div>
          </div>
          <div class="bg-slate-50 rounded-xl p-3 col-span-2">
            <div class="text-slate-500">XIRR(연율, 추정)</div>
            <div id="xirr" class="text-lg font-semibold mono">-</div>
          </div>
        </div>
        <p class="text-[12px] text-slate-400 mt-2">가격은 마지막 거래일 종가 기준. 환율/수수료/세금 미반영.</p>
      </div>
    </section>

    <section class="card mb-6">
      <h2 class="font-semibold mb-3">평가금액 추이</h2>
      <canvas id="valueChart" height="120"></canvas>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-3">체결 내역</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-slate-500">
            <tr>
              <th class="text-left py-2">체결일</th>
              <th class="text-right py-2">체결가(S&P)</th>
              <th class="text-right py-2">납입액(원)</th>
              <th class="text-right py-2">취득 단위(지수 단위)</th>
            </tr>
          </thead>
          <tbody id="fills-body" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-400">
      <p>데이터 소스: <a class="underline" href="https://stooq.com/" target="_blank" rel="noreferrer">Stooq</a> (^spx 일별 종가). 교육/개인 용도 예시 코드.</p>
      <p class="mt-1">오류/제안: GitHub Issues에서 남겨주세요.</p>
    </footer>
  </div>

  <script>
    // ---- Utilities ----
    const fmtKRW = v => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(v);
    const fmtPct = v => (isFinite(v) ? (v*100).toFixed(2) + '%' : '-')

    function toDate(str){
      // Accepts 'YYYY-MM-DD' or input type date value
      return new Date(str + 'T00:00:00Z');
    }

    function addMonths(date, m){
      const d = new Date(date); d.setUTCMonth(d.getUTCMonth()+m); return d;
    }

    function ymd(d){
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,'0');
      const da = String(d.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    // Newton-Raphson IRR on irregular cash flows
    function xirr(cashflows){
      // cashflows: [{date: Date, amount: number}] negative=outflow, positive=inflow
      const t0 = cashflows[0].date;
      const f = r => cashflows.reduce((acc, cf) => acc + cf.amount / Math.pow(1+r, (cf.date - t0)/(365.2425*24*3600*1000)), 0);
      const df = r => cashflows.reduce((acc, cf) => acc - ((cf.date - t0)/(365.2425*24*3600*1000)) * cf.amount / Math.pow(1+r, 1+ (cf.date - t0)/(365.2425*24*3600*1000)), 0);
      let r = 0.1; // initial guess 10%
      for(let i=0;i<50;i++){
        const fr = f(r); const dfr = df(r);
        if (!isFinite(fr) || !isFinite(dfr) || Math.abs(dfr) < 1e-12) break;
        const nr = r - fr/dfr;
        if (Math.abs(nr - r) < 1e-7) { r = nr; break; }
        r = nr;
      }
      return (isFinite(r) && r > -0.9999) ? r : NaN;
    }

    // ---- Data Fetch ----
    async function fetchSPX(){
      // Stooq daily CSV for ^spx
      const url = 'https://stooq.com/q/d/l/?s=%5Espx&i=d';
      const res = await fetch(url, { cache: 'no-cache' });
      if(!res.ok) throw new Error('가격 데이터를 가져오지 못했습니다.');
      const csv = await res.text();
      const lines = csv.trim().split(/\r?\n/);
      const header = lines.shift(); // date,open,high,low,close,volume
      const rows = lines.map(l=>{
        const [date, open, high, low, close] = l.split(',');
        return { date, close: parseFloat(close) };
      }).filter(r=>isFinite(r.close));
      return rows; // ascending by date
    }

    function findFirstTradingOnOrAfter(rows, targetYMD){
      for(const r of rows){
        if (r.date >= targetYMD) return r;
      }
      return null; // future date beyond last trading day
    }

    function simulate(rows, config){
      const fills = [];
      let totalUnits = 0;
      let invested = 0;

      // per contribution
      for(const c of config.contributions){
        const trade = findFirstTradingOnOrAfter(rows, c.date);
        if (!trade) continue; // skip if beyond data
        const units = c.amount / trade.close; // ignoring FX and fees
        totalUnits += units;
        invested += c.amount;
        fills.push({ date: trade.date, price: trade.close, amount: c.amount, units });
      }

      // build equity curve from first fill
      const last = rows[rows.length-1];
      const startIdx = rows.findIndex(r => r.date >= (fills[0]?.date || rows[rows.length-1].date));
      const curve = [];
      let accUnits = 0;
      let iFill = 0;
      for(let i = startIdx; i < rows.length; i++){
        const r = rows[i];
        // add any fills occurring this date
        while(iFill < fills.length && fills[iFill].date === r.date){
          accUnits += fills[iFill].units;
          iFill++;
        }
        curve.push({ date: r.date, value: accUnits * r.close });
      }

      const currentValue = totalUnits * rows[rows.length-1].close;
      const pnl = currentValue - invested;
      const roi = invested > 0 ? pnl / invested : NaN;

      // XIRR cashflows: outflows at contribution intent date (trade date for accuracy), inflow today as current value
      const cashflows = fills.map(f => ({ date: toDate(f.date), amount: -f.amount }));
      cashflows.push({ date: toDate(rows[rows.length-1].date), amount: currentValue });
      const irr = xirr(cashflows);

      return { fills, invested, currentValue, pnl, roi, irr, curve };
    }

    // ---- UI Wiring ----
    let chart;
    function renderChart(curve){
      const ctx = document.getElementById('valueChart');
      const labels = curve.map(p => p.date);
      const data = curve.map(p => p.value);
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ data, label: '평가금액', tension: 0.18, borderWidth: 2, pointRadius: 0 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { ticks: { callback: (v)=> fmtKRW(v) } } }
        }
      });
    }

    function renderFills(fills){
      const tb = document.getElementById('fills-body');
      tb.innerHTML = '';
      for(const f of fills){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2">${f.date}</td>
          <td class="py-2 text-right mono">${f.price.toFixed(2)}</td>
          <td class="py-2 text-right mono">${fmtKRW(f.amount)}</td>
          <td class="py-2 text-right mono">${f.units.toFixed(6)}</td>
        `;
        tb.appendChild(tr);
      }
    }

    function renderSummary({invested, currentValue, pnl, roi, irr}){
      document.getElementById('invested').textContent = fmtKRW(invested);
      document.getElementById('value').textContent = fmtKRW(currentValue);
      document.getElementById('pnl').textContent = (pnl>=0?'+':'') + fmtKRW(Math.abs(pnl));
      document.getElementById('roi').textContent = isFinite(roi) ? (roi*100).toFixed(2) + '%' : '-';
      document.getElementById('xirr').textContent = isFinite(irr) ? (irr*100).toFixed(2) + '%' : '-';
    }

    function defaultConfig(){
      // Pre-fill based on user's plan
      return {
        contributions: [
          { date: '2025-10-06', amount: 180000 },
          { date: '2025-10-24', amount: 180000 },
          // Recurring will be expanded dynamically when running
        ],
        recurring: {
          day: 24, amount: 180000, startMonth: '2025-11' // YYYY-MM
        }
      };
    }

    function expandRecurring(rows, recurring){
      const out = [];
      // from startMonth until last trading date month, include those with trade date <= last
      const lastYMD = rows[rows.length-1].date;
      let cur = toDate(recurring.startMonth + '-01');
      while (ymd(cur).slice(0,7) <= lastYMD.slice(0,7)){
        const y = cur.getUTCFullYear();
        const m = cur.getUTCMonth() + 1;
        const d = Math.min(recurring.day, 28); // simple bound
        const candidate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const trade = findFirstTradingOnOrAfter(rows, candidate);
        if (trade && trade.date <= lastYMD){
          out.push({ date: trade.date, amount: recurring.amount });
        }
        cur = addMonths(cur, 1);
      }
      return out;
    }

    async function run(){
      try{
        const rows = await fetchSPX();
        const cfg = defaultConfig();
        // read UI values
        const fd = document.getElementById('first-date').value || cfg.contributions[0].date;
        const fa = parseFloat(document.getElementById('first-amount').value || cfg.contributions[0].amount);
        const sd = document.getElementById('second-date').value || cfg.contributions[1].date;
        const sa = parseFloat(document.getElementById('second-amount').value || cfg.contributions[1].amount);
        const rday = parseInt(document.getElementById('recurring-day').value || cfg.recurring.day);
        const ramt = parseFloat(document.getElementById('recurring-amount').value || cfg.recurring.amount);
        const rstart = document.getElementById('recurring-start').value || cfg.recurring.startMonth;

        const contributions = [
          { date: fd, amount: fa },
          { date: sd, amount: sa },
        ];
        const recurring = { day: rday, amount: ramt, startMonth: rstart };
        const expanded = expandRecurring(rows, recurring);
        contributions.push(...expanded);

        const result = simulate(rows, { contributions });
        renderSummary(result);
        renderChart(result.curve);
        renderFills(result.fills);
      }catch(err){
        alert(err.message || String(err));
      }
    }

    function resetUI(){
      const cfg = defaultConfig();
      document.getElementById('first-date').value = cfg.contributions[0].date;
      document.getElementById('first-amount').value = cfg.contributions[0].amount;
      document.getElementById('second-date').value = cfg.contributions[1].date;
      document.getElementById('second-amount').value = cfg.contributions[1].amount;
      document.getElementById('recurring-day').value = cfg.recurring.day;
      document.getElementById('recurring-amount').value = cfg.recurring.amount;
      document.getElementById('recurring-start').value = cfg.recurring.startMonth;
    }

    document.getElementById('run-btn').addEventListener('click', run);
    document.getElementById('reset-btn').addEventListener('click', ()=>{ resetUI(); });

    // Initialize defaults and run once
    resetUI();
    run();
  </script>
</body>
</html>
