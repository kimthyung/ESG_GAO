<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>S&P 500 sim</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>body{font-feature-settings:"ss01" on,"case" on}</style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-2">미국을 따르지 않은 죗값</h1>
    <p class="text-sm text-slate-600 mb-6">2025-10-06·2025-10-24 각 180,000원 투자, 이후 매월 24일 동일 금액 투자. <span class="font-semibold">입금 시점은 한국시간(KST) 밤 23:59</span>이며, 이를 <span class="font-semibold">미국 날짜로 변환</span>해 해당 날짜 <em>이후 첫 거래일</em>에 체결합니다. 환율·세금 반영, 배당은 원천징수 후 전액 재투자.</p>

    <div id="summary" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">곗돈</div>
        <div id="invested" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">평가금액</div>
        <div id="value" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">평가손익(세후)</div>
        <div id="pnl" class="text-lg font-semibold">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">수익률(세후)</div>
        <div id="roi" class="text-lg font-semibold">-</div>
      </div>

      <!-- ✅ 새로 추가된 20년 예측 카드 -->
      <div class="bg-white rounded-lg shadow p-3">
        <div class="text-slate-500 text-sm">20년 예측</div>
        <div id="proj" class="text-lg font-semibold mb-2">-</div>
        <button id="projBtn" class="px-3 py-1.5 rounded-md bg-slate-900 text-white text-sm">예측하기</button>
        <p id="projNote" class="text-[11px] text-slate-500 mt-1"></p>
      </div>
    </div>

    <canvas id="chart" height="120"></canvas>
    <p id="notice" class="text-xs text-amber-600 mt-4 hidden"></p>
  </div>

  <script>
    // === 세금/배당/환율/시간대 가정 ===
    var TAX_RATE_CG = 0.22;
    var TAX_DED_KRW = 2500000;
    var DIVIDEND_YIELD_ANNUAL = 0.013;
    var DIV_WITHHOLDING = 0.15;
    var TRADING_DAYS = 252;
    var DEPOSIT_LOCAL_TIME = '23:59';

    function fmtKRW(v){ return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v); }
    function ymd(d){ return d.toISOString().slice(0,10); }
    function addMonths(d,m){ var x=new Date(d); x.setUTCMonth(x.getUTCMonth()+m); return x; }

    function kstDepositToEtYmd(kstYmd, hhmm){
      var parts = (hhmm||'23:59').split(':');
      var iso = kstYmd + 'T' + parts[0].padStart(2,'0') + ':' + parts[1].padStart(2,'0') + ':00+09:00';
      var kst = new Date(iso);
      var etYmd = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/New_York', year:'numeric', month:'2-digit', day:'2-digit' }).format(kst);
      return etYmd;
    }

    async function fetchSPX(){
      var urls=[
        'https://stooq.com/q/d/l/?s=%5Espx&i=d',
        'https://r.jina.ai/http://stooq.com/q/d/l/?s=%5Espx&i=d',
        'https://r.jina.ai/http://stooq.pl/q/d/l/?s=%5Espx&i=d'
      ];
      function parseCsv(text){
        var lines = text.trim().split(/\r?\n/).filter(function(l){return /\d{4}-\d{2}-\d{2},/.test(l) || /^date,open,high,low,close/i.test(l)});
        if(/^date,open,high,low,close/i.test(lines[0])) lines.shift();
        var rows = lines.map(function(l){ var parts=l.split(','); return {date:parts[0], close:Number(parts[4])}; })
                        .filter(function(r){return Number.isFinite(r.close)});
        if(rows.length===0) throw new Error('SPX CSV parse error');
        return rows;
      }
      for(var i=0;i<urls.length;i++){
        try{ var res=await fetch(urls[i],{cache:'no-cache'}); if(!res.ok) throw 0; return parseCsv(await res.text()); }catch(e){}
      }
      throw new Error('S&P 500 가격을 가져오지 못했습니다.');
    }

    async function fetchUSDKRW(fromYMD, toYMD){
      var eps=[
        'https://api.exchangerate.host/timeseries?base=USD&symbols=KRW&start_date='+fromYMD+'&end_date='+toYMD,
        'https://api.frankfurter.app/'+fromYMD+'..'+toYMD+'?from=USD&to=KRW'
      ];
      for(var i=0;i<eps.length;i++){
        try{
          var r = await fetch(eps[i],{cache:'no-cache'}); if(!r.ok) throw 0; var j = await r.json();
          var rates = {}; var k;
          if(j.rates){
            for(k in j.rates){ if(j.rates.hasOwnProperty(k)){ var obj=j.rates[k]; var v = obj.KRW || obj['KRW']; if(v) rates[k]=Number(v); }}
          }
          var keys = Object.keys(rates).sort(); if(keys.length===0) throw 0;
          var arr = keys.map(function(k){return {date:k, rate:rates[k]};}).sort(function(a,b){return a.date<b.date?-1:1});
          return {
            getRateOnOrBefore: function(d){
              var lo=0, hi=arr.length-1, ans=null; var mid;
              while(lo<=hi){ mid=(lo+hi>>1); if(arr[mid].date<=d){ ans=arr[mid]; lo=mid+1; } else { hi=mid-1; } }
              return ans? ans.rate : null;
            },
            firstDate: arr[0].date,
            lastDate: arr[arr.length-1].date
          };
        }catch(e){}
      }
      throw new Error('USD/KRW 환율을 가져오지 못했습니다.');
    }

    async function run(){
      try{
        var spx = await fetchSPX();

        var kstPlans=[ {kstDate:'2025-10-06', amountKRW:180000}, {kstDate:'2025-10-23', amountKRW:180000} ];
        var curKst = new Date(Date.UTC(2025,10,24,14,59,0));
        var lastYMD = spx[spx.length-1].date;
        function kstYmd(d){ return new Intl.DateTimeFormat('en-CA',{ timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' }).format(d); }
        while(kstYmd(curKst).slice(0,7) <= lastYMD.slice(0,7)){
          kstPlans.push({ kstDate: kstYmd(curKst), amountKRW: 180000 });
          curKst = addMonths(curKst, 1);
        }

        var plans=[];
        for(var a=0;a<kstPlans.length;a++){
          var kp = kstPlans[a];
          var etBase = kstDepositToEtYmd(kp.kstDate, DEPOSIT_LOCAL_TIME);
          var trade = spx.find(function(r){ return r.date >= etBase; });
          if(trade){ plans.push({ date: trade.date, amountKRW: kp.amountKRW }); }
        }

        var fromYMD = plans[0].date;
        var fx = await fetchUSDKRW(fromYMD, lastYMD);

        var fills=[], totalUnits=0, investedKRW=0;
        for(var i=0;i<plans.length;i++){
          var p = plans[i]; var trade = spx.find(function(r){return r.date>=p.date}); if(!trade) continue;
          var rate = fx.getRateOnOrBefore(trade.date); if(!Number.isFinite(rate)) continue;
          var priceKRW = trade.close * rate; var units = p.amountKRW / priceKRW;
          totalUnits += units; investedKRW += p.amountKRW;
          fills.push({date:trade.date, priceUSD:trade.close, rateKRW:rate, priceKRW:priceKRW, amountKRW:p.amountKRW, units:units});
        }

        var divDaily = DIVIDEND_YIELD_ANNUAL / TRADING_DAYS;
        var curve=[], accUnits=0, j=0; var sortedFills=fills.slice().sort(function(a,b){return a.date<b.date?-1:1});
        for(var k=0;k<spx.length;k++){
          var r = spx[k];
          while(j<sortedFills.length && sortedFills[j].date===r.date){ accUnits += sortedFills[j].units; j++; }
          if(accUnits>0){
            var rate2 = fx.getRateOnOrBefore(r.date);
            if(Number.isFinite(rate2)){
              var dayValueKRW = accUnits * r.close * rate2;
              var divKRW = dayValueKRW * divDaily * (1 -  DIV_WITHHOLDING);
              var addedUnits = divKRW / (r.close * rate2);
              if(Number.isFinite(addedUnits) && addedUnits>0) accUnits += addedUnits;
              curve.push({date:r.date, valueKRW: accUnits * r.close * rate2});
            }
          }
        }

        var lastRate = fx.getRateOnOrBefore(lastYMD);
        var currentValueKRW = accUnits * spx[spx.length-1].close * lastRate;
        var grossGain = currentValueKRW - investedKRW;
        var taxable = Math.max(0, grossGain - TAX_DED_KRW);
        var tax = taxable * TAX_RATE_CG;
        var netValueKRW = currentValueKRW - Math.max(0, tax);
        var pnlAfterTax = netValueKRW - investedKRW;
        var roiAfterTax = investedKRW>0 ? pnlAfterTax / investedKRW : 0;

        document.getElementById('invested').textContent = fmtKRW(investedKRW);
        document.getElementById('value').textContent = fmtKRW(netValueKRW);
        document.getElementById('pnl').textContent = (pnlAfterTax>=0?'+':'')+fmtKRW(Math.abs(pnlAfterTax));
        document.getElementById('roi').textContent = (roiAfterTax*100).toFixed(2)+'%';

        // ✅ 평가손익 색상 표시
        const pnlElem = document.getElementById('pnl');
        pnlElem.classList.toggle('text-green-600', pnlAfterTax >= 0);
        pnlElem.classList.toggle('text-red-600', pnlAfterTax < 0);

        new Chart(document.getElementById('chart'), {
          type:'line',
          data:{ labels:curve.map(p=>p.date), datasets:[{ data:curve.map(p=>p.valueKRW), label:'평가금액(배당 재투자·세전·원화)', borderWidth:2, tension:0.18, pointRadius:0 }] },
          options:{ plugins:{ legend:{display:false} }, scales:{ y:{ ticks:{ callback:v=>new Intl.NumberFormat('ko-KR').format(v) } } } }
        });

        var n=document.getElementById('notice');
        n.classList.remove('hidden');
        n.textContent = '무지를 반성합시다.';

        // === 20년 예측 버튼 ===
        var firstUSD = spx[0].close;
        var lastUSD  = spx[spx.length-1].close;
        var nDays    = Math.max(1, spx.length - 1);
        var muDaily  = Math.pow(lastUSD / firstUSD, 1 / nDays) - 1;
        var monthlyReturn = Math.pow(1 + muDaily, TRADING_DAYS / 12) - 1;
        var monthlyDivNet = (DIVIDEND_YIELD_ANNUAL * (1 - DIV_WITHHOLDING)) / 12;

        function project20YearsKRW() {
          var months = 240;
          var valueKRW = currentValueKRW;
          var investKRW = investedKRW;
          for (var m = 0; m < months; m++) {
            valueKRW *= (1 + monthlyReturn + monthlyDivNet);
            valueKRW += 180000;
            investKRW += 180000;
          }
          var grossGain = valueKRW - investKRW;
          var taxable = Math.max(0, grossGain - TAX_DED_KRW);
          var tax = taxable * TAX_RATE_CG;
          var netKRW = valueKRW - Math.max(0, tax);
          var pnl = netKRW - investKRW;
          var roi = investKRW > 0 ? (pnl / investKRW) : 0;
          return { investKRW, netKRW, pnl, roi };
        }

        var projBtn = document.getElementById('projBtn');
        var projOut = document.getElementById('proj');
        var projNote = document.getElementById('projNote');

        projBtn.addEventListener('click', function(){
          try{
            var r = project20YearsKRW();
            projOut.textContent = fmtKRW(r.netKRW) + ' (세후)';
            projOut.classList.toggle('text-green-600', r.pnl >= 0);
            projOut.classList.toggle('text-red-600', r.pnl < 0);
            projNote.textContent =
              '가정: 과거 평균 수익률을 월 단위로 근사, 배당은 세후 재투자, 환율은 현재 고정, ' +
              '20년간 매월 180,000원 추가 납입, 종료 시점 양도세 반영';
          }catch(e){
            projOut.textContent = '예측 실패';
            projOut.classList.remove('text-green-600','text-red-600');
            projNote.textContent = '오류: ' + (e.message || String(e));
          }
        });

      }catch(err){
        console.error(err);
        var n2=document.getElementById('notice');
        n2.classList.remove('hidden');
        n2.textContent = '데이터/계산 오류: ' + (err.message||String(err));
      }
    }

    run();
  </script>
</body>
</html>
